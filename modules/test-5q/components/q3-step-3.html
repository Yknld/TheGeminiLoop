<div class="module-container">
  <style>
    /* Styling for the module */
    .module-container {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #ffffff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      max-width: 650px; /* Slightly wider for inputs and new buttons */
      margin: 20px auto;
      box-sizing: border-box;
      color: #333;
      text-align: center;
      transition: all 0.3s ease-in-out;
    }

    .math-formula {
      font-size: 2.5em;
      font-weight: bold;
      margin-bottom: 25px;
      color: #2563eb;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      min-height: 60px;
      line-height: 1.2;
    }

    .formula-part-wrapper {
        position: relative;
        display: inline-flex;
        justify-content: center;
        align-items: center;
        min-width: 45px;
        height: 1.2em;
        margin: 0 8px;
    }

    /* Base styles for all dynamic formula parts */
    .formula-variable, .formula-value-sub, .formula-value-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex; /* For centering content */
        justify-content: center;
        align-items: center;
        box-sizing: border-box;
        transition: opacity 0.8s ease-in-out, transform 0.8s ease-in-out;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    /* Initial state of variable (visible) */
    .formula-variable {
        opacity: 1;
        transform: translateY(0);
    }

    /* State when variable fades out */
    .formula-variable.fade-out {
        opacity: 0;
        transform: translateY(-20px);
        pointer-events: none;
    }

    /* Initial state of substituted value (hidden, lower) */
    .formula-value-sub {
        opacity: 0;
        transform: translateY(20px);
    }

    /* State when substituted value fades in */
    .formula-value-sub.fade-in {
        opacity: 1;
        transform: translateY(0);
    }

    /* Hide element completely (overrides display:flex) */
    .hidden {
        display: none !important;
        opacity: 0; /* Also hide visually during transition to display:none */
        pointer-events: none; /* Disable interaction when hidden */
    }

    /* Styles for the input fields */
    .formula-value-input {
        font-family: inherit;
        font-size: 0.9em;
        font-weight: bold;
        color: #2563eb;
        background: #f0f4ff;
        border: 1px solid #a8c7fa;
        border-radius: 5px;
        padding: 0 5px;
        text-align: center;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        -webkit-appearance: none; /* Remove default spinner for number input */
        -moz-appearance: textfield; /* Remove default spinner for number input */
        opacity: 0; /* Start hidden for transition */
        transform: translateY(20px);
        pointer-events: none; /* Disable interaction when hidden */
    }
    .formula-value-input:focus {
        border-color: #1d4ed8;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        outline: none;
    }
    .formula-value-input.show-input {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto; /* Enable interaction */
    }


    .formula-static {
        margin: 0 8px;
    }

    .specific-values {
      font-size: 1.3em;
      margin-top: -10px;
      margin-bottom: 25px;
      color: #16a34a;
      font-weight: 500;
      transition: opacity 0.5s ease;
    }
    
    .instruction-text {
      font-size: 1.05em;
      color: #555;
      margin-top: 15px;
      margin-bottom: 20px;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.6s ease-out, transform 0.6s ease-out, margin 0.3s ease;
      line-height: 1.5;
      min-height: 40px; /* Prevent layout shift */
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
    }
    .instruction-text.show {
        opacity: 1;
        transform: translateY(0);
    }


    .btn-show-result {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 14px 30px;
      font-size: 1.1em;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease, opacity 0.5s ease;
      margin-top: 0;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      min-width: 180px; /* Consistent width */
    }

    .btn-show-result:hover {
      background-color: #1d4ed8;
      transform: translateY(-2px);
    }

    .btn-show-result:active {
        transform: translateY(0);
    }

    .result-value {
      font-size: 1em;
      font-weight: bold;
      color: #16a34a;
      margin-left: 15px;
      opacity: 0;
      transition: opacity 0.8s ease-in-out;
      min-width: 50px; /* Reserve space */
    }

    .result-value.show {
      opacity: 1;
    }

    /* Post-calculation actions */
    .post-calculation-actions {
        margin-top: 30px;
        transition: opacity 0.5s ease, transform 0.5s ease;
        opacity: 0;
        transform: translateY(20px);
        pointer-events: none;
    }
    .post-calculation-actions.show {
        opacity: 1;
        transform: translateY(0);
        pointer-events: auto;
    }
    .explanation-text {
        font-size: 1.1em;
        color: #444;
        margin-bottom: 25px;
        font-weight: 500;
        line-height: 1.4;
    }
    .action-btn {
        background-color: #16a34a; /* Green for Next Step */
        color: white;
        border: none;
        padding: 12px 25px;
        font-size: 1em;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease;
        margin: 0 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        min-width: 160px;
    }
    .action-btn:hover {
        transform: translateY(-2px);
    }
    .action-btn.next-step-btn:hover { background-color: #148f42; }
    .action-btn.try-again-btn { background-color: #f59e0b; } /* Orange for Try Another */
    .action-btn.try-again-btn:hover { background-color: #d97706; }

    /* Rectangle Visual */
    .rectangle-visual {
        margin: 20px auto 30px auto;
        border: 1px dashed #ccc; /* Subtle border for visual space */
        border-radius: 8px;
        padding: 10px;
        max-width: 250px; /* Control size */
        height: 180px; /* Fixed height for consistent layout */
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden; /* Hide parts of rectangle if scaled too large */
        transition: opacity 0.5s ease, height 0.5s ease, margin 0.5s ease, padding 0.5s ease;
    }

    .rectangle-svg {
        max-width: 100%;
        max-height: 100%;
    }
    .rectangle-svg rect {
        transition: all 0.5s ease-out;
    }
    .rectangle-svg text {
        transition: all 0.5s ease-out;
    }

  </style>

  <div class="math-formula">
    A
    <span class="formula-static">=</span>
    <span class="formula-part-wrapper">
      <span class="formula-variable" id="l-var">l</span>
      <span class="formula-value-sub hidden" id="l-val-display">6</span>
      <input type="number" class="formula-value-input hidden" id="l-input" value="6" min="1" max="100" aria-label="Length input">
    </span>
    <span class="formula-static">×</span>
    <span class="formula-part-wrapper">
      <span class="formula-variable" id="w-var">w</span>
      <span class="formula-value-sub hidden" id="w-val-display">4</span>
      <input type="number" class="formula-value-input hidden" id="w-input" value="4" min="1" max="100" aria-label="Width input">
    </span>
    <span class="result-value hidden" id="area-result"></span>
  </div>

  <div class="specific-values" id="initial-values-display">
    l = 6, w = 4
  </div>

  <div class="rectangle-visual" id="rectangleVisual">
    <svg width="200" height="150" viewBox="0 0 200 150" class="rectangle-svg">
        <rect x="50" y="50" id="rectangleShape" width="90" height="60" fill="none" stroke="#2563eb" stroke-width="2"/>
        <text x="95" y="40" text-anchor="middle" fill="#2563eb" font-size="14" id="lengthText">L = 6</text>
        <text x="40" y="80" text-anchor="end" dominant-baseline="middle" fill="#2563eb" font-size="14" id="widthText">W = 4</text>
    </svg>
  </div>

  <p id="instructionText" class="instruction-text hidden"></p>

  <button class="btn-show-result" id="calculateAreaBtn"></button>

  <div class="post-calculation-actions" id="postCalculationActions">
      <p class="explanation-text" id="explanationText"></p>
      <button class="action-btn next-step-btn" id="nextStepBtn">Next Step</button>
      <button class="action-btn try-again-btn" id="tryAnotherBtn">Try Another Example</button>
  </div>

  <script>
    (function() {
      const lVar = document.getElementById('l-var');
      const wVar = document.getElementById('w-var');
      const lValDisplay = document.getElementById('l-val-display');
      const wValDisplay = document.getElementById('w-val-display');
      const lInput = document.getElementById('l-input');
      const wInput = document.getElementById('w-input');
      const calculateAreaBtn = document.getElementById('calculateAreaBtn');
      const areaResult = document.getElementById('area-result');
      const instructionText = document.getElementById('instructionText');
      const initialValuesDisplay = document.getElementById('initial-values-display');
      const postCalculationActions = document.getElementById('postCalculationActions');
      const explanationText = document.getElementById('explanationText');
      const nextStepBtn = document.getElementById('nextStepBtn');
      const tryAnotherBtn = document.getElementById('tryAnotherBtn');
      const rectangleVisual = document.getElementById('rectangleVisual');
      const rectangleShape = document.getElementById('rectangleShape');
      const lengthText = document.getElementById('lengthText');
      const widthText = document.getElementById('widthText');

      let currentL = 6;
      let currentW = 4;
      let isTryAnotherMode = false;

      // Function to update the rectangle visual
      const updateRectangleVisual = (l, w) => {
        const svgWidth = 200;
        const svgHeight = 150;
        const padding = 20; // Minimum padding inside SVG

        // Ensure L and W are positive for aspect ratio calculation and display
        l = Math.max(1, l);
        w = Math.max(1, w);

        const aspectRatio = l / w;

        let displayWidth, displayHeight;
        
        const maxVisualWidth = svgWidth - 2 * padding;
        const maxVisualHeight = svgHeight - 2 * padding;

        // Calculate dimensions while maintaining aspect ratio and fitting within bounds
        if (l / maxVisualWidth > w / maxVisualHeight) {
            displayWidth = maxVisualWidth;
            displayHeight = maxVisualWidth / aspectRatio;
        } else {
            displayHeight = maxVisualHeight;
            displayWidth = maxVisualHeight * aspectRatio;
        }
        
        // Ensure dimensions are not too small for visibility
        displayWidth = Math.max(20, displayWidth);
        displayHeight = Math.max(20, displayHeight);

        // Center the rectangle
        const rectX = (svgWidth - displayWidth) / 2;
        const rectY = (svgHeight - displayHeight) / 2;

        rectangleShape.setAttribute('width', displayWidth);
        rectangleShape.setAttribute('height', displayHeight);
        rectangleShape.setAttribute('x', rectX);
        rectangleShape.setAttribute('y', rectY);

        lengthText.textContent = `L = ${l}`;
        lengthText.setAttribute('x', rectX + displayWidth / 2);
        lengthText.setAttribute('y', rectY - 8);

        widthText.textContent = `W = ${w}`;
        widthText.setAttribute('x', rectX - 8);
        widthText.setAttribute('y', rectY + displayHeight / 2);
      };

      // Initial setup and animation
      const init = () => {
        // Reset element states
        lVar.classList.remove('fade-out');
        lValDisplay.classList.remove('fade-in');
        wVar.classList.remove('fade-out');
        wValDisplay.classList.remove('fade-in');
        
        lValDisplay.classList.add('hidden'); // Ensure hidden initially
        wValDisplay.classList.add('hidden');
        lInput.classList.add('hidden'); // Ensure inputs are hidden
        wInput.classList.add('hidden');
        lInput.classList.remove('show-input'); // Remove any active input styling
        wInput.classList.remove('show-input');
        
        calculateAreaBtn.classList.remove('hidden');
        calculateAreaBtn.textContent = 'Calculate Area'; // Ensure button text is correct
        
        instructionText.classList.add('hidden');
        postCalculationActions.classList.remove('show');
        areaResult.classList.add('hidden');
        initialValuesDisplay.classList.remove('hidden');
        rectangleVisual.classList.remove('hidden');
        isTryAnotherMode = false;

        // Initial rectangle visual update (for 6x4)
        updateRectangleVisual(currentL, currentW);

        // Trigger the substitution animation after a short delay
        setTimeout(() => {
          lVar.classList.add('fade-out');
          lValDisplay.classList.remove('hidden'); 
          lValDisplay.classList.add('fade-in');
          wVar.classList.add('fade-out');
          wValDisplay.classList.remove('hidden');
          wValDisplay.classList.add('fade-in');

          // After substitution, reveal the instruction text
          setTimeout(() => {
            instructionText.textContent = "The length and width have been substituted. Click the button to calculate the Area!";
            instructionText.classList.remove('hidden'); // Show instruction
            instructionText.classList.add('show');
          }, 500);
        }, 700);
      };

      calculateAreaBtn.addEventListener('click', function() {
        let l, w;

        if (isTryAnotherMode) {
          l = parseFloat(lInput.value);
          w = parseFloat(wInput.value);

          if (isNaN(l) || isNaN(w) || l <= 0 || w <= 0) {
            instructionText.textContent = "Please enter valid positive numbers for Length and Width (1-100).";
            instructionText.classList.remove('hidden');
            instructionText.classList.add('show');
            return;
          }
          currentL = l;
          currentW = w;

          // Hide inputs, show display spans with new values
          lInput.classList.remove('show-input'); // Remove for fade out
          wInput.classList.remove('show-input');
          // Delay hiding to allow fade out transition
          setTimeout(() => { 
              lInput.classList.add('hidden');
              wInput.classList.add('hidden');
          }, 800); 

          lValDisplay.textContent = currentL;
          wValDisplay.textContent = currentW;
          lValDisplay.classList.remove('hidden'); 
          wValDisplay.classList.remove('hidden');
          lValDisplay.classList.add('fade-in');
          wValDisplay.classList.add('fade-in');

        } else {
          l = currentL; // From fixed initial values
          w = currentW; // From fixed initial values
        }

        const area = l * w;
        areaResult.textContent = ` = ${area}`;
        areaResult.classList.remove('hidden');
        areaResult.classList.add('show');
        
        calculateAreaBtn.classList.add('hidden');
        instructionText.classList.add('hidden');

        explanationText.textContent = `Area = Length × Width = ${l} × ${w} = ${area} square units.`;
        postCalculationActions.classList.add('show');

        // Update rectangle visual for current calculated values
        updateRectangleVisual(l, w);
      });

      nextStepBtn.addEventListener('click', function() {
        alert("Proceeding to the next step of the module! (This is a placeholder action for actual navigation).");
        // In a real application, this would trigger a page change or module progression.
        // For this self-contained component, we simply leave the calculated value displayed
        // and allow the user to 'Try Another Example' or click 'Next Step' again.
      });

      tryAnotherBtn.addEventListener('click', function() {
        isTryAnotherMode = true;
        postCalculationActions.classList.remove('show');
        areaResult.classList.remove('show');
        areaResult.classList.add('hidden');
        initialValuesDisplay.classList.add('hidden');

        // Hide display spans for current values
        lValDisplay.classList.remove('fade-in'); // Remove fade-in state
        wValDisplay.classList.remove('fade-in');
        lValDisplay.classList.add('hidden'); // Then hide
        wValDisplay.classList.add('hidden');
        
        // Show inputs
        lInput.classList.remove('hidden');
        wInput.classList.remove('hidden');
        lInput.classList.add('show-input'); 
        wInput.classList.add('show-input');
        
        // Reset input values to current successful values
        lInput.value = currentL; 
        wInput.value = currentW;

        instructionText.textContent = "Enter new values for Length and Width (1-100), then click Calculate Area.";
        instructionText.classList.remove('hidden');
        instructionText.classList.add('show');
        
        calculateAreaBtn.classList.remove('hidden');
        calculateAreaBtn.textContent = 'Calculate Area'; // Ensure button text is correct

        // Update visual with current input values (which are currentL, currentW initially)
        updateRectangleVisual(currentL, currentW);

        // Focus on the first input
        lInput.focus();
      });

      init(); // Call init function on script load
    })();
  </script>
</div>
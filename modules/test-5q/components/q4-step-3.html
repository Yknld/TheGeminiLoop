<div class="module-container">
  <style>
    /* General Styling & Variables */
    :root {
      --primary-blue: #3b82f6; /* A slightly softer blue for accents and focus */
      --light-blue-bg: #e0f2fe; /* Light blue for expression background */
      --dark-grey-text: #1f2937; /* Main text color */
      --medium-grey-text: #4b5563; /* Label color */
      --light-grey-bg: #f9fafb; /* Container background, very light */
      --border-color: #e2e8f0; /* Input and array border */
      --error-red: #ef4444; /* Error text color */
      --input-border-focus: #93c5fd; /* Lighter blue for focus outline */
    }

    .module-container {
      font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Modern, clean font */
      background-color: var(--light-grey-bg);
      border-radius: 16px; /* More pronounced rounded corners */
      padding: 30px; /* Increased padding for spaciousness */
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12); /* Softer, larger shadow for depth */
      max-width: 600px; /* Constrain width for better readability and focus */
      width: 100%;
      box-sizing: border-box;
      color: var(--dark-grey-text);
      display: flex;
      flex-direction: column;
      gap: 28px; /* Consistent spacing between major sections */
      margin: 0 auto; /* Center the module on the page */
    }

    /* Component Title */
    .module-container h2 {
      font-size: 1.8rem; /* Prominent title size */
      font-weight: 700; /* Bold title */
      color: var(--dark-grey-text);
      margin-top: 0;
      margin-bottom: 10px; /* Space below title */
      text-align: center; /* Center align the title */
    }

    /* Controls Group (Inputs) */
    .module-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 35px; /* Increased gap between control groups */
      justify-content: center;
      align-items: flex-end; /* Align inputs at their bottom edges */
      margin-bottom: 20px;
    }

    .module-control-group {
      display: flex;
      flex-direction: column;
      align-items: center; /* Center label, input, and error message */
      gap: 8px; /* Gap between elements within a control group */
      min-width: 140px; /* Ensure inputs have sufficient minimum width */
    }

    .module-control-group label {
      font-weight: 600;
      color: var(--medium-grey-text);
      font-size: 1.1rem; /* Slightly larger labels for clarity */
      text-align: center;
    }

    .module-control-group input[type="number"] {
      width: 100px; /* Consistent width for input fields */
      padding: 12px 15px; /* Generous padding */
      border: 2px solid var(--border-color); /* Thicker, softer border */
      border-radius: 10px; /* More rounded input fields */
      font-size: 1.7rem; /* Significantly larger for prominence and readability */
      font-weight: 700; /* Bolder text for numbers */
      color: var(--primary-blue); /* Emphasize input numbers with color */
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.08); /* Subtle inner shadow */
      transition: border-color 0.2s ease, box-shadow 0.2s ease; /* Smooth transitions */
      text-align: center;
      -moz-appearance: textfield; /* Remove default spin buttons for Firefox */
    }
    .module-control-group input[type="number"]::-webkit-outer-spin-button,
    .module-control-group input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none; /* Remove default spin buttons for Webkit browsers */
      margin: 0;
    }

    .module-control-group input[type="number"]:focus {
      border-color: var(--primary-blue);
      box-shadow: 0 0 0 4px var(--input-border-focus); /* Softer, primary-color focused outline */
      outline: none; /* Remove default outline */
    }

    /* Error Message Styling */
    .error-message {
      color: var(--error-red);
      font-size: 0.9rem; /* Smaller font for error messages */
      min-height: 1.2em; /* Reserve space to prevent layout shifts when message appears/disappears */
      opacity: 0; /* Initially hidden */
      transition: opacity 0.3s ease-in-out; /* Smooth fade effect */
      text-align: center;
      display: block; /* Ensure it takes full width below input */
    }
    .error-message.visible {
      opacity: 1; /* Make visible when 'visible' class is applied */
    }

    /* Multiplication Expression Display */
    .module-expression {
      font-size: 3rem; /* Very large for a strong visual impact */
      font-weight: 800; /* Extra bold */
      color: var(--dark-grey-text);
      text-align: center;
      margin-bottom: 25px; /* More space below the expression */
      padding: 15px 20px; /* Generous padding */
      background-color: var(--light-blue-bg); /* Soft blue background */
      border-radius: 12px; /* Consistent rounded corners */
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); /* Enhanced shadow */
      white-space: nowrap; /* Prevent expression from breaking onto new lines */
      display: flex; /* Use flexbox for precise vertical alignment */
      justify-content: center;
      align-items: center; /* Vertically center content, fixing misalignment */
      line-height: 1.2; /* Better line spacing */
    }

    /* Array Visualization Area */
    .module-array-visualization {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px; /* Increased gap between rows of items */
      padding: 20px; /* More padding inside the visualization area */
      background-color: #ffffff; /* Clean white background */
      border-radius: 12px;
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.06); /* Subtle inner shadow */
      min-height: 150px; /* Ensures some height even if no items */
      overflow-x: auto; /* Allow horizontal scrolling if rows are too wide */
      overflow-y: auto; /* Allow vertical scrolling if too many rows */
      max-height: 350px; /* Maximum height for the array */
      border: 1px solid var(--border-color); /* Subtle border for definition */
    }

    .module-array-row {
      display: flex;
      gap: 10px; /* Increased gap between items in a row */
      justify-content: center;
      flex-wrap: wrap; /* Allow items to wrap to next line if row is too wide */
    }

    .module-array-item {
      font-size: 3rem; /* Larger apple icon for better engagement */
      line-height: 1; /* Ensures consistent spacing for emoji */
      display: inline-block;
      cursor: default; /* Indicate non-clickable */
      transition: transform 0.15s ease-out, filter 0.15s ease-out; /* Smooth hover effects */
    }

    .module-array-item:hover {
      transform: scale(1.1); /* Slight enlargement on hover */
      filter: brightness(1.05); /* Subtle brightness increase on hover */
    }
  </style>

  <!-- Removed: 'Module: test-5q | Q4 | Step 4 of 5' -->
  <h2>Counting Apples in Groups - Step 4</h2>

  <div class="module-controls">
    <div class="module-control-group">
      <label for="numGroups">Number of Groups (G)</label>
      <input type="number" id="numGroups" value="3" min="1" max="10" />
      <span id="numGroupsError" class="error-message" aria-live="polite"></span> <!-- Added error span with ARIA live region -->
    </div>
    <div class="module-control-group">
      <label for="itemsPerGroup">Items per Group (I)</label>
      <input type="number" id="itemsPerGroup" value="4" min="1" max="12" />
      <span id="itemsPerGroupError" class="error-message" aria-live="polite"></span> <!-- Added error span with ARIA live region -->
    </div>
  </div>

  <div id="multiplicationExpression" class="module-expression">
    3 &times; 4
  </div>

  <div id="arrayVisualization" class="module-array-visualization">
    <!-- Array will be rendered here by JavaScript -->
  </div>

  <script>
    (function() {
      const numGroupsInput = document.getElementById('numGroups');
      const itemsPerGroupInput = document.getElementById('itemsPerGroup');
      const multiplicationExpression = document.getElementById('multiplicationExpression');
      const arrayVisualization = document.getElementById('arrayVisualization');
      const numGroupsError = document.getElementById('numGroupsError');
      const itemsPerGroupError = document.getElementById('itemsPerGroupError');

      const appleIcon = 'üçé'; // Unicode for red apple

      /**
       * Validates an input field, displays an error if necessary, and returns the clamped valid value for calculation.
       * It also updates the input field's value to the clamped version to ensure consistency.
       * @param {HTMLInputElement} inputElement - The input field DOM element.
       * @param {HTMLElement} errorElement - The span for displaying error messages.
       * @param {number} minVal - The minimum acceptable value.
       * @param {number} maxVal - The maximum acceptable value.
       * @returns {number} The validated and clamped integer value, always within min/max bounds.
       */
      function validateAndClampInput(inputElement, errorElement, minVal, maxVal) {
          const rawValue = inputElement.value.trim();
          let parsedValue = parseInt(rawValue);
          let validValueForCalculation;
          let errorMessage = '';
          let errorVisible = false;

          if (rawValue === '') {
              errorMessage = 'Required.';
              errorVisible = true;
              validValueForCalculation = minVal; // Default to min for calculation
          } else if (isNaN(parsedValue)) {
              errorMessage = 'Must be a number.';
              errorVisible = true;
              validValueForCalculation = minVal; // Default to min for calculation
          } else if (parsedValue < minVal || parsedValue > maxVal) {
              errorMessage = `Between ${minVal} and ${maxVal}.`;
              errorVisible = true;
              validValueForCalculation = Math.max(minVal, Math.min(parsedValue, maxVal)); // Clamp value
          } else {
              // Input is valid
              validValueForCalculation = parsedValue;
          }

          // Update error message display with a smooth transition
          errorElement.textContent = errorMessage;
          errorElement.classList.toggle('visible', errorVisible);

          // Update the input field's value to the valid, clamped value.
          // This provides immediate visual correction, while the error message explains why.
          // We check `isNaN(parseInt(inputElement.value))` to handle cases where user types non-numbers
          // and prevent accidental updates if the user's valid input matches the clamped value.
          if (parseInt(inputElement.value) !== validValueForCalculation || isNaN(parseInt(inputElement.value))) {
             inputElement.value = validValueForCalculation;
          }
          
          return validValueForCalculation;
      }

      function updateVisualization() {
        // Retrieve min/max attributes directly from the input elements for robustness
        const G_min = parseInt(numGroupsInput.min);
        const G_max = parseInt(numGroupsInput.max);
        const I_min = parseInt(itemsPerGroupInput.min);
        const I_max = parseInt(itemsPerGroupInput.max);

        // Use the new validation function to get the safely clamped values for G and I
        let G = validateAndClampInput(numGroupsInput, numGroupsError, G_min, G_max);
        let I = validateAndClampInput(itemsPerGroupInput, itemsPerGroupError, I_min, I_max);

        // Update the multiplication expression display
        multiplicationExpression.textContent = `${G} \u00D7 ${I}`; // \u00D7 is the multiplication sign

        // Clear existing array visualization
        arrayVisualization.innerHTML = '';

        // Create the array visualization based on validated G and I values
        for (let i = 0; i < G; i++) {
          const rowDiv = document.createElement('div');
          rowDiv.classList.add('module-array-row');
          for (let j = 0; j < I; j++) {
            const itemSpan = document.createElement('span');
            itemSpan.classList.add('module-array-item');
            itemSpan.textContent = appleIcon;
            rowDiv.appendChild(itemSpan);
          }
          arrayVisualization.appendChild(rowDiv);
        }
      }

      // Initialize the component: Set initial values and render the visualization
      updateVisualization();

      // Add event listeners for real-time updates as the user types or changes input values
      numGroupsInput.addEventListener('input', updateVisualization);
      itemsPerGroupInput.addEventListener('input', updateVisualization);
    })();
  </script>
</div>